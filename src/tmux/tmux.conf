# Charlynder tmux config (fixed)
# Date: 2025-11-25

# --- Escape key responsiveness ---
# 0 reduces escape delays (helps vim, but harmless)
set -sg escape-time 0

# --- allow reloading of config ---
unbind r
bind r source-file ~/.config/tmux/tmux.conf

# --- mouse ---
set -g mouse on
# Enable OSC 8 hyperlink support for all terminal types
set -as terminal-features ',*:hyperlinks'

# --- prefix key ---
unbind C-b
set -g prefix C-a
bind C-a send-prefix

# --- window management ---
unbind %
unbind '"'
unbind /
bind / split-window -h    # vertical split (side by side)
bind - split-window -v    # horizontal split (top/bottom)
bind-key x kill-pane
bind-key & kill-window

# --- POPUP MANAGEMENT (FIXED) ---
# Opens a popup shell. 
# To close normally: Type 'exit' or press Ctrl-d (standard shell exit).
bind p display-popup -E -w 80% -h 80% -d "#{pane_current_path}"

# To force-close the popup without exiting the shell manually:
# We use Alt-Escape (M-Escape) to avoid breaking the 'escape-time 0' setting above.
bind -n M-Escape display-popup -C

set -g cursor-style blinking-block
# set -g cursor-color "#eb6f92"   # uncomment only if your tmux supports cursor-color

# --- pane/window navigation (kept) ---
# bind-key -n C-h select-pane -L
# bind-key -n C-j select-pane -D
# bind-key -n C-k select-pane -U
# bind-key -n C-l select-pane -R

bind-key h select-pane -L
bind-key j select-pane -D
bind-key k select-pane -U
bind-key l select-pane -R

bind-key -r C-h select-window -t :-
bind-key -r C-l select-window -t :+

# Enable OSC 8 hyperlink support for all terminal types
set -as terminal-features ',*:hyperlinks'

# --- IMPORTANT: do not set mode-keys to vi or emacs ---
# Removing any lines such as `setw -g mode-keys vi` or `set -g mode-keys vi`
# ensures tmux will not forcibly map tmux copy-mode into an editor keymap.

# If some plugin or external config adds vi-mode, explicitly unbind the common
# copy-mode-vi keys here to reduce risk of accidental vim-like behavior in copy mode.
if-shell 'tmux list-keys -T copy-mode-vi >/dev/null 2>&1' \
    "unbind -T copy-mode-vi h; unbind -T copy-mode-vi j; unbind -T copy-mode-vi k; unbind -T copy-mode-vi l; unbind -T copy-mode-vi v; unbind -T copy-mode-vi Enter" ""

# Open URLs from current pane using fzf-tmux-url (keeps original behavior)
bind u run-shell -b "tmux capture-pane -J -p | grep -oE '(https?):\\/\\/[^ ]+' | fzf-tmux -d20 --multi --bind alt-a:select-all,alt-d:deselect-all | xargs open"

# --- TPM plugins (kept) ---
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'christoomey/vim-tmux-navigator'
set -g @plugin 'sainnhe/tmux-fzf'
set -g @plugin 'wfxr/tmux-fzf-url'
set -g @plugin 'omerxx/tmux-sessionx'
set -g @plugin 'rose-pine/tmux'
set -g @plugin 'alexwforsythe/tmux-which-key'

# Rose Pine theme settings (kept)
set -g @rose_pine_variant 'main'
set -g @rose_pine_host 'on'
set -g @rose_pine_user 'on'
set -g @rose_pine_directory 'on'
set -g @rose_pine_date_time '%H:%M'
set -g @rose_pine_default_window_behavior 'on'

# Initialize TPM (keep at bottom)
if-shell "test -f ~/.config/tmux/plugins/tpm/tpm" \
    "run '~/.config/tmux/plugins/tpm/tpm'" \
    "run '~/.tmux/plugins/tpm/tpm'"

# Run rose-pine plugin if available (optional; harmless if missing but may print an error)
if-shell "test -f ~/.config/tmux/plugins/rose-pine/rose-pine.tmux" \
    "run-shell ~/.config/tmux/plugins/rose-pine/rose-pine.tmux" \
    ""
