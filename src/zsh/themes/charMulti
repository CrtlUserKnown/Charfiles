# CharMulti
#
# Date Created: 10.10.2025
#
# A custom Zsh prompt theme featuring a dynamic arrow indicator that changes
# direction based on your typing (forward when typing, backward when deleting).
# Includes full git integration with branch display and status indicators for
# staged and unstaged changes. The prompt shows your exit code, command history,
# username, current directory, and displays the current time and date above the
# main prompt line.

# create the symbol for the apple icon
function cancer {
  echo -n "\u264B\uFE0E"
}

# Function to display status word (Rosé Pine colors)
function status_word {
  local exit_code=$?
  if [[ $exit_code -eq 0 ]]; then
    echo -n "%F{#c4a7e7}${exit_code} success%f"
  else
    echo -n "%F{#eb6f92}${exit_code} failed%f"
  fi
}

# --- theme:duration ---
# Variables for tracking command duration
typeset -g _prompt_cmd_timestamp
typeset -g _prompt_cmd_duration

# Function to format duration nicely
function format_duration {
  local duration=$1
  local hours=$((duration / 3600))
  local minutes=$(((duration % 3600) / 60))
  local seconds=$((duration % 60))
  
  if [[ $duration -lt 1 ]]; then
    echo ""
  elif [[ $hours -gt 0 ]]; then
    printf "%dh %dm %ds" $hours $minutes $seconds
  elif [[ $minutes -gt 0 ]]; then
    printf "%dm %ds" $minutes $seconds
  else
    printf "%ds" $seconds
  fi
}

# Function to display duration (Rosé Pine colors)
function duration_info {
  if [[ -n $_prompt_cmd_duration ]]; then
    local formatted=$(format_duration $_prompt_cmd_duration)
    if [[ -n $formatted ]]; then
      echo -n "%F{#9ccfd8}${formatted}%f"
    fi
  fi
}

# Record timestamp before command execution
function record_start_time {
  _prompt_cmd_timestamp=$EPOCHSECONDS
}

# Calculate duration after command execution
function record_end_time {
  local exit_code=$?
  if [[ -n $_prompt_cmd_timestamp ]]; then
    _prompt_cmd_duration=$((EPOCHSECONDS - _prompt_cmd_timestamp))
    unset _prompt_cmd_timestamp
  fi
  return $exit_code
}

# --- theme:vcs ---
# Initialize vcs_info for git branch display
autoload -Uz vcs_info
setopt prompt_subst

# Configure vcs_info styles (Rosé Pine colors)
zstyle ':vcs_info:*' check-for-changes true
zstyle ':vcs_info:*' unstagedstr '%F{#eb6f92}*'   # display this when there are unstaged changes (love/red)
zstyle ':vcs_info:*' stagedstr '%F{#f6c177}+'  # display this when there are staged changes (gold/yellow)
zstyle ':vcs_info:*' actionformats '%F{5}%F{#c4a7e7}%b%F{#f6c177}|%F{#eb6f92}%a%c%u%F{5}%f '  # iris purple branch
zstyle ':vcs_info:*' formats '%F{5}%F{#c4a7e7}%b%c%u%F{5}%f '  # iris purple branch name
zstyle ':vcs_info:svn:*' branchformat '%b'
zstyle ':vcs_info:svn:*' actionformats '%F{5}%F{#c4a7e7}%b%F{#eb6f92}:%F{#f6c177}%i%F{#f6c177}|%F{#eb6f92}%a%c%u%F{5}%f '
zstyle ':vcs_info:svn:*' formats '%F{5}%F{#c4a7e7}%b%F{#eb6f92}:%F{#f6c177}%i%c%u%F{5}%f '
zstyle ':vcs_info:*' enable git cvs svn

# --- theme:precmd ---
# Function to update vcs_info and reset arrow after command
theme_precmd() {
  vcs_info
  record_end_time
}

# --- theme:prompt ---
# Set up the prompt with dynamic vcs_info and duration (Rosé Pine colors)
PROMPT=' $(cancer) (%(?,%F{#c4a7e7}success%f %?,%F{#eb6f92}failed%f %?) | %h$(duration_info)) %{$reset_color%}${vcs_info_msg_0_}%{$reset_color%}
 [%F{#907aa9}%n%f: %~] » '
RPROMPT='%W %B%F{#c4a7e7}%t%f%b'


# Add the precmd hook to update git info automatically
autoload -U add-zsh-hook
add-zsh-hook precmd theme_precmd
