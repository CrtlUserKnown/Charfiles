# User ~/.zshrc (complete; forces emacs line-editing for interactive shells)
# Date: 2025-11-25
# Purpose: Ensure zsh uses emacs-style editing (so typing inserts characters immediately),
#          only apply zle/widget/bindkey work in interactive shells, and keep existing prompt/theme.

# ---- Basic environment ----
export LANG=en_US.UTF-8
export LC_ALL=en_US.UTF-8

# If you use a framework (oh-my-zsh, prezto, zim, etc.), source it here.
# Example (uncomment only if you use oh-my-zsh):
# source $ZSH/oh-my-zsh.sh

# ---- Theme/prompt & git info (kept from your theme) ----
autoload -Uz vcs_info
setopt prompt_subst

# VCS styles (example from your theme)
zstyle ':vcs_info:*' check-for-changes true
zstyle ':vcs_info:*' unstagedstr '%F{#eb6f92}*'
zstyle ':vcs_info:*' stagedstr '%F{#f6c177}+'
zstyle ':vcs_info:*' actionformats '%F{5}%F{#c4a7e7}%b%F{#f6c177}|%F{#eb6f92}%a%c%u%F{5}%f '
zstyle ':vcs_info:*' formats '%F{5}%F{#c4a7e7}%b%c%u%F{5}%f '
zstyle ':vcs_info:*' enable git cvs svn

# Example env functions used by your prompt
function muxFraktur { echo -n "\U0001D57E"; }
function cancer { echo -n "\u264B\uFE0E"; }

ARROW_DIRECTION="»"  # Default arrow direction

# ---- Interactive-only: zle widgets and bindkeys ----
if [[ -o interactive ]]; then

  # Force emacs editing mode (disable zsh vi-mode).
  # If some other file or plugin re-enables vi-mode later, place `bindkey -e` at the end of this file.
  bindkey -e

  # Custom widgets (kept from your theme)
  function my-self-insert() {
    ARROW_DIRECTION="»"
    zle self-insert
    zle reset-prompt
  }
  function my-backward-delete-char() {
    ARROW_DIRECTION="«"
    zle backward-delete-char
    zle reset-prompt
  }
  function my-backward-char() {
    ARROW_DIRECTION="«"
    zle backward-char
    zle reset-prompt
  }
  function my-forward-char() {
    ARROW_DIRECTION="»"
    zle forward-char
    zle reset-prompt
  }
  function my-up-line-or-history() {
    ARROW_DIRECTION="↑"
    zle up-line-or-history
    zle reset-prompt
  }
  function my-down-line-or-history() {
    ARROW_DIRECTION="↓"
    zle down-line-or-history
    zle reset-prompt
  }

  # Register widgets
  zle -N my-backward-delete-char
  zle -N my-self-insert
  zle -N my-backward-char
  zle -N my-forward-char
  zle -N my-up-line-or-history
  zle -N my-down-line-or-history

  # Bindings (emacs keymap)
  bindkey '^?' my-backward-delete-char  # Backspace
  bindkey '^H' my-backward-delete-char  # Ctrl+H

  # Arrow keys (common sequences)
  bindkey -M emacs '^[[D' my-backward-char
  bindkey -M emacs '^[[C' my-forward-char
  bindkey -M emacs '^[[A' my-up-line-or-history
  bindkey -M emacs '^[[B' my-down-line-or-history

  # Alternative sequences (some terminals)
  bindkey -M emacs '^[OD' my-backward-char
  bindkey -M emacs '^[OC' my-forward-char
  bindkey -M emacs '^[OA' my-up-line-or-history
  bindkey -M emacs '^[OB' my-down-line-or-history

  # Bind alphanumerics to custom self-insert widget in emacs map
  for key in {a..z} {A..Z} {0..9}; do
    bindkey -M emacs "$key" my-self-insert
  done

  # Common punctuation
  bindkey -M emacs ' ' my-self-insert
  bindkey -M emacs '.' my-self-insert
  bindkey -M emacs ',' my-self-insert
  bindkey -M emacs '!' my-self-insert
  bindkey -M emacs '?' my-self-insert
  bindkey -M emacs ':' my-self-insert
  bindkey -M emacs ';' my-self-insert

fi  # interactive guard

# ---- Prompt building (kept/compatible) ----
theme_precmd() {
  vcs_info
  ARROW_DIRECTION="»"
}

function get_arrow { echo -n "${ARROW_DIRECTION}"; }

function build_prompt {
  local prompt_str=""
  local env_indicators=""

  if [[ -n "$VIRTUAL_ENV" ]]; then env_indicators+="%F{#9ccfd8}(py:$(basename $VIRTUAL_ENV))%f "; fi
  if [[ -n "$CONDA_DEFAULT_ENV" ]]; then env_indicators+="%F{#f6c177}(conda:${CONDA_DEFAULT_ENV})%f "; fi
  if [[ -n "$AWS_PROFILE" ]]; then env_indicators+="%F{#eb6f92}[aws:${AWS_PROFILE}]%f "; fi
  if [[ -f /.dockerenv ]]; then env_indicators+="%F{#c4a7e7}[docker]%f "; fi
  if [[ -n "$KUBECTL_CONTEXT" ]]; then env_indicators+="%F{#31748f}[k8s:${KUBECTL_CONTEXT}]%f "; fi
  if [[ -n "$SSH_CONNECTION" ]]; then env_indicators+="%F{#ebbcba}[ssh:%m]%f "; fi
  if [[ -n "$JAVA_HOME" ]]; then env_indicators+="%F{#f6c177}(java:$(basename $JAVA_HOME))%f "; fi

  if [[ -n "$TMUX" ]]; then
    prompt_str=" $(muxFraktur) [%F{#9ccfd8}%~%f] %{$reset_color%}${vcs_info_msg_0_}%{$reset_color%}$(get_arrow) "
  else
    prompt_str=" $(cancer) [%F{#907aa9}%n%f: %~] %{$reset_color%}${vcs_info_msg_0_}%{$reset_color%} ${ARROW_DIRECTION} "
  fi

  echo -n "$prompt_str"
}

PROMPT='$(build_prompt)'
add-zsh-hook precmd theme_precmd

# ---- Safety: ensure emacs mode at the very end ----
# Some frameworks re-enable vi-mode later; this final bindkey -e ensures emacs wins.
if [[ -o interactive ]]; then
  bindkey -e
fi
